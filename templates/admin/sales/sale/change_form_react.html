{% extends "admin/change_form.html" %}
{% load static i18n admin_urls admin_modify %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static 'admin/css/sale_form_react.css' %}">
<style>
  /* Masquer complÃ¨tement le formulaire Django */
  form#sale_form,
  .inline-group,
  .submit-row {
    display: none !important;
  }
  
  /* Afficher le container React */
  #content-main {
    display: block !important;
  }
</style>
{% endblock %}

{% block content %}
{{ block.super }}
<!-- Container pour React (sera rempli par React) -->
<div id="content-main"></div>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<!-- Variables globales pour React (chargÃ©es en premier) -->
<script>
    window.SALE_FORM_CONFIG = {
        apiBaseUrl: '/api/sales/',
        csrfToken: '{{ csrf_token }}',
        saleId: {% if original %}{{ original.id }}{% else %}null{% endif %},
        isNewSale: {% if original %}false{% else %}true{% endif %},
    };
    
    console.log('ğŸ”µ Template React chargÃ©');
    console.log('ğŸ”µ SALE_FORM_CONFIG:', window.SALE_FORM_CONFIG);
</script>

<!-- Babel Standalone doit Ãªtre chargÃ© AVANT le script JSX (sans async defer) -->
<script src="{% static 'js/babel.min.js' %}"></script>

<!-- React et ReactDOM -->
<script async defer src="{% static 'js/react.production.min.js' %}"></script>
<script async defer src="{% static 'js/react-dom.production.min.js' %}"></script>

<!-- Charger et transformer le script JSX -->
<script>
  // Attendre que tous les scripts soient chargÃ©s
  function loadReactApp() {
    // VÃ©rifier que Babel est disponible
    if (typeof window.Babel === 'undefined') {
      console.log('â³ En attente de Babel...');
      setTimeout(loadReactApp, 100);
      return;
    }
    
    // VÃ©rifier que React et ReactDOM sont disponibles
    if (typeof window.React === 'undefined' || typeof window.ReactDOM === 'undefined') {
      console.log('â³ En attente de React et ReactDOM...');
      setTimeout(loadReactApp, 100);
      return;
    }
    
    console.log('âœ… Toutes les dÃ©pendances sont chargÃ©es');
    
    // Charger le script JSX
    const jsxUrl = '{% static "admin/js/sale_form_react.jsx" %}';
    fetch(jsxUrl)
      .then(response => {
        if (!response.ok) {
          throw new Error('Erreur HTTP: ' + response.status);
        }
        return response.text();
      })
      .then(jsxCode => {
        try {
          console.log('âœ… Script JSX chargÃ©, transformation en cours...');
          
          // Transformer le JSX avec Babel
          const transformed = window.Babel.transform(jsxCode, {
            presets: ['react']
          }).code;
          
          // ExÃ©cuter le code transformÃ©
          const script = document.createElement('script');
          script.textContent = transformed;
          document.head.appendChild(script);
          
          console.log('âœ… Script JSX transformÃ© et exÃ©cutÃ©');
        } catch (error) {
          console.error('âŒ Erreur lors de la transformation JSX:', error);
          console.error('DÃ©tails:', error.stack);
        }
      })
      .catch(error => {
        console.error('âŒ Erreur lors du chargement du script JSX:', error);
        console.error('URL tentÃ©e:', jsxUrl);
      });
  }
  
  // DÃ©marrer le chargement
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadReactApp);
  } else {
    loadReactApp();
  }
</script>

<script>
  // Debug final
  window.addEventListener('load', function() {
    console.log('ğŸŸ¢ Page complÃ¨tement chargÃ©e');
    console.log('ğŸŸ¢ React:', typeof window.React !== 'undefined' ? 'âœ…' : 'âŒ');
    console.log('ğŸŸ¢ ReactDOM:', typeof window.ReactDOM !== 'undefined' ? 'âœ…' : 'âŒ');
    console.log('ğŸŸ¢ Babel:', typeof window.Babel !== 'undefined' ? 'âœ…' : 'âŒ');
    console.log('ğŸŸ¢ Container:', document.getElementById('content-main') ? 'âœ…' : 'âŒ');
  });
</script>
{% endblock %}
